Ext.ns("Ynzc");
Ext.ns("Ynzc.manage");
Ynzc.manage.UnitManageGrid=Ext.extend(Ext.grid.GridPanel,{
                id:'unitmanagegrid',
                initComponent:function(){
                    var sm=new Ext.grid.CheckboxSelectionModel();
                    var fm=Ext.form;
                    var comboStore=new Ext.data.Store({
		                    url:"main/user.html?action=getAllUserList",
		                    autoLoad:true,
		                    reader:new Ext.data.JsonReader({
		                        root : 'dataList',
		                        fields:[{name:'id'},{name:'realname'}]
		                    })
		                });
		            comboStore.load();
                    var cm = new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),sm,
                     {header:'编号',sortable:true,dataIndex:"id"},
                    {header:'行政区划',sortable:true,dataIndex:"region"},
                    {header:'使用单位',sortable:true,dataIndex:"useunit"},
                    {header:'负责人',sortable:true,dataIndex:"responsiblemen"},
                    {header:'联系电话',sortable:true,dataIndex:"linktel"},
                    {header:'单位地址',sortable:true,dataIndex:"address"},
                    {header:'邮政编码',sortable:true,dataIndex:"zipcode"},
                    {header:'条章编号',sortable:true,dataIndex:"chaptercode"},
                    {header:'号牌代码',sortable:true,dataIndex:"platecode"},
                    {header:'登记审核人',sortable:true,dataIndex:"registman"},
                    {header:'牌证管理员',sortable:true,dataIndex:"paizhengman"},
                    {header:'业务领导岗',sortable:true,dataIndex:"leaderman"},
                    {header:'管理人员',sortable:true,dataIndex:"userid",
                     renderer:function(value,record){
                           var index=comboStore.find('id',value);
                           if(index>=0){
                             var record=comboStore.getAt(index);
                             return record.data.realname;
                            }else{
                               return "异常的管理人员";
                           }
                        }
                    }
                    ]);
                    var reader=new Ext.data.JsonReader({
                        totalProperty:"totalCount",
                        root:"data",
                        autoLoad:true,
                        fields:[
                        {name : 'id'},{name : 'region'},{name : 'regionid'},{name : 'useunit'},
                        {name : 'responsiblemen'},{name : 'linktel'},{name : 'address'},
                        {name : 'zipcode'},{name : 'chaptercode'},{name : 'platecode'},{name : 'registman'},{name : 'paizhengman'},{name : 'leaderman'},
                        {name:'userid'}
                        ]
                    });
                    var ds=new Ext.data.Store({
                        scopte:this,
                        url:'main/unitManage.html?action=getUnitManageList',
                        reader:reader,
                        sortInfo:{
                            field:'id',
                            direction:'DESC'
                        }
                    });
                    Ext.apply(this,{
                        id:'unitmanagegrid',
                        plain:true,
                        layout:'fit',
                        border:false,
                        cm:cm,
                        sm:sm,
                        frame:true,
                        store:ds,
                        loadMask:true,
                        plugins:new Ext.ux.grid.Search({
                            width:200,
                            iconCls:false
                        }),
                        tbar:[{
                            id:'typeAdd',
                            text:"添加",
                            iconCls:"icon-Add",
                            handler:function(){
                                    new Ext.Window({
                                        id:'addWin',
                                        title:"添加单位信息",
                                        height:"auto",
                                        modal:true,
                                        width:400,
                                        layout:'form',
                                        buttonAlign:"center",
                                        resizable:false,
                                        items:[{
                                        	frame:true,
                                        	layout:"column",
                                        	items:[{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:"combRegion",
	                                        		fieldLabel:"行政区划",
	                                        		xtype:'regcombo',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		hidden:true,
                                        		items:[{
                                        			id:'txtRegionid',
	                                        		fieldLabel:"行政区划ID",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtUseunit',
	                                        		fieldLabel:"使用单位",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtResponsiblemen',
	                                        		fieldLabel:"负责人",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtLinktel',
	                                        		fieldLabel:"联系电话",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtAddress',
	                                        		fieldLabel:"单位地址",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtZipcode',
	                                        		fieldLabel:"邮政编码",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtChaptercode',
	                                        		fieldLabel:"条章编号",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtPlatecode',
	                                        		fieldLabel:"号牌代码",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtRegistman',
	                                        		fieldLabel:"登记审核人",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtPaiZhengMan',
	                                        		fieldLabel:"牌证管理员",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtLeaderMan',
	                                        		fieldLabel:"业务领导岗",
	                                        		xtype:'textfield',
	                                        		anchor:'98%'
                                        		}]
                                        	},{
                                        		columnWidth:1,
                                        		layout:'form',
                                        		labelWidth:80,
                                        		items:[{
                                        			id:'txtUserid',
	                                        		fieldLabel:"管理人员",
	                                        		xtype:'combo',
	                                        		displayField : 'realname',
									                valueField : 'id',
									                typeAhead : true,
									                mode : 'remote',
									                editable : false,
									                selectOnFoucs : true,
									                triggerAction : 'all',
									                store:comboStore,
									                emptyText:"请选择管理员",
									                anchor:'98%'
                                        		}]
                                        	}]
                                        }],
                                        buttons:[{
                                        	id:'SaveBtn',
                                        	text:"保存",
                                        	handler:function(){
                                        	   if(Ext.getCmp("combRegion").getValue()==""){Ext.ux.Toast.msg("提示","请选择行政区划.");return;}
                                               if(Ext.getCmp("txtRegionid").getValue()==""){Ext.ux.Toast.msg("提示","请选择行政区划.");return;}
                                               if(Ext.getCmp("txtUseunit").getValue()==""){Ext.ux.Toast.msg("提示","请填写使用单位.");return;}
                                               if(Ext.getCmp("txtResponsiblemen").getValue()==""){Ext.ux.Toast.msg("提示","请填写负责人.");return;}
                                               if(Ext.getCmp("txtLinktel").getValue()==""){Ext.ux.Toast.msg("提示","请填写联系电话.");return;}
                                               if(Ext.getCmp("txtAddress").getValue()==""){Ext.ux.Toast.msg("提示","请填写单位地址.");return;}
                                               if(Ext.getCmp("txtZipcode").getValue()==""){Ext.ux.Toast.msg("提示","请填写邮政编码.");return;}
                                               if(Ext.getCmp("txtChaptercode").getValue()==""){Ext.ux.Toast.msg("提示","请填写条章编号.");return;}
                                               if(Ext.getCmp("txtPlatecode").getValue()==""){Ext.ux.Toast.msg("提示","请填写号牌代码.");return;}
                                               if(Ext.getCmp("txtRegistman").getValue()==""){Ext.ux.Toast.msg("提示","请填写登记审核人.");return;}
                                               if(Ext.getCmp("txtPaiZhengMan").getValue()==""){Ext.ux.Toast.msg("提示","请填写牌证管理员.");return;}
                                               if(Ext.getCmp("txtLeaderMan").getValue()==""){Ext.ux.Toast.msg("提示","请填写业务领导.");return;}
                                               if(Ext.getCmp("txtUserid").getValue()==""){Ext.ux.Toast.msg("提示","请选择管理人员.");return;}
                                               Ext.Ajax.request({
                                                  url:"main/unitManage.html?action=addUnitManage",
                                                  method:"post",
                                                  success:function(){Ext.ux.Toast.msg("提示","信息保存成功.");Ext.getCmp("addWin").close(); ds.reload();},
                                                  failure:function(){ Ext.Msg.alert("警告","<font color=red>与服务器通信失败!</font>");},
                                                  params:{
                                                       	region:Ext.getCmp("combRegion").getValue(),
                                                        regionid:Ext.getCmp("txtRegionid").getValue(),
                                                        useunit:Ext.getCmp("txtUseunit").getValue(),
                                                        responsiblemen:Ext.getCmp("txtResponsiblemen").getValue(),
                                                        linktel:Ext.getCmp("txtLinktel").getValue(),
                                                        address:Ext.getCmp("txtAddress").getValue(),
                                                        zipcode:Ext.getCmp("txtZipcode").getValue(),
                                                        chaptercode:Ext.getCmp("txtChaptercode").getValue(),
                                                        platecode:Ext.getCmp("txtPlatecode").getValue(),
                                                        registMan:Ext.getCmp("txtRegistman").getValue(),
                                                        paizhengman:Ext.getCmp("txtPaiZhengMan").getValue(),
                                                        leaderman:Ext.getCmp("txtLeaderMan").getValue(),
                                                        userid:Ext.getCmp("txtUserid").getValue()}
                                                 });
                                        	}
                                        },{
                                        	id:'CancelBtn',
                                        	text:"取消",
                                        	handler:function(){
                                        		Ext.getCmp("addWin").close();
                                        	}
                                        }] 
                                    }).show(Ext.getCmp("typeAdd").getEl());
                                }                            
                            },
                            '-',{
                            text:"删除",
                            iconCls:"icon-Del",
                            handler:function(){
                                    var selections=this.selModel.getSelections();
                                    var n=selections.length;
                                    if(n==0){
                                        Ext.ux.Toast.msg("提示","请选中要删除的信息!");
                                        return;
                                    }
                                    var rds=[];
                                    for(i=0;i<n;i++){
                                        rds.push(selections[i].data);
                                    }
                                     Ext.Msg.show({
                                        title:'系统确认',
                                        msg:'你是否确认删除选中的信息?',
                                        buttons:Ext.Msg.YESNO,
                                        scope:this,
                                        icon : Ext.MessageBox.QUESTION,
                                        fn:function(btn){
                                            if(btn=="yes"){
                                                Ext.Ajax.request({
                                                    url:"main/unitManage.html?action=delUnitManage",
                                                    method:"post",
                                                    success:function(){
                                                        Ext.ux.Toast.msg("提示","已成功删除选中的信息");
                                                        ds.reload();
                                                    },
                                                    faliure:function(){
                                                        Ext.Msg.alert("警告","<font color=red>与服务器通信失败!</font>");
                                                    },
                                                    params:{
                                                        dellist:Ext.util.JSON.encode(rds)
                                                    }
                                                });
                                            }
                                        }
                                     });                                
                            }.createDelegate(this)
                        }],
                        bbar:new Ext.PagingToolbar({
                            pageSize:20,
                            store:ds,
                            displayInfo:true,
                            displayMsg : '显示第 {0} 条到 {1} 条记录，共 {2} 条',
                            emptyMsg : '无记录'
                        }),
                        viewConfig:{
                            forceFit:true
                        }
                    });
                    Ynzc.manage.UnitManageGrid.superclass.initComponent.apply(this,arguments);
                    ds.load({
                        params:{
                            start:0,
                            limit:20
                        }
                    });
                      this.on("rowdblclick",function(grid,index,event){
		                      var record=grid.getStore().getAt(index);
		                      new Ext.Window({
		                          id:'typeUpdatewin',
		                          title:"修改单位信息",
		                          height:"auto",
		                          modal:true,
		                          width:400,
		                          layout:'form',
		                          buttonAlign:"center",
		                          resizable:false,
		                          items:[{
		                          	frame:true,
		                          	layout:"column",
		                          	items:[{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:"combRegion",
			                           		fieldLabel:"行政区划",
			                           		xtype:'regcombo',
			                           		value:record.data.region,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		hidden:true,
		                          		items:[{
		                          			id:'txtRegionid',
			                           		fieldLabel:"行政区划ID",
			                           		xtype:'textfield',
			                           		value:record.data.regionid,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateUseunit',
			                           		fieldLabel:"使用单位",
			                           		xtype:'textfield',
			                           		value:record.data.useunit,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateResponsiblemen',
			                           		fieldLabel:"负责人",
			                           		xtype:'textfield',
			                           		value:record.data.responsiblemen,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateLinktel',
			                           		fieldLabel:"联系电话",
			                           		xtype:'textfield',
			                           		value:record.data.linktel,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateAddress',
			                           		fieldLabel:"单位地址",
			                           		xtype:'textfield',
			                           		value:record.data.address,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateZipcode',
			                           		fieldLabel:"邮政编码",
			                           		xtype:'textfield',
			                           		value:record.data.zipcode,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdateChaptercode',
			                           		fieldLabel:"条章编号",
			                           		xtype:'textfield',
			                           		value:record.data.chaptercode,
			                           		anchor:'98%'
		                          		}]
		                          	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          			id:'txtUpdatePlatecode',
			                           		fieldLabel:"号牌代码",
			                           		xtype:'textfield',
			                           		value:record.data.platecode,
			                           		anchor:'98%'
		                          		}]
		                          	},{
                                		columnWidth:1,
                                		layout:'form',
                                		labelWidth:80,
                                		items:[{
                                			id:'txtUpdateRegistman',
                                    		fieldLabel:"登记审核人",
                                    		xtype:'textfield',
                                    		value:record.data.registman,
                                    		anchor:'98%'
                                		}]
                                	},{
                                		columnWidth:1,
                                		layout:'form',
                                		labelWidth:80,
                                		items:[{
                                			id:'txtUpdatePaiZhengMan',
                                    		fieldLabel:"牌证管理员",
                                    		xtype:'textfield',
                                    		value:record.data.paizhengman,
                                    		anchor:'98%'
                                		}]
                                	},{
                                		columnWidth:1,
                                		layout:'form',
                                		labelWidth:80,
                                		items:[{
                                			id:'txtUpdateLeaderMan',
                                    		fieldLabel:"业务领导岗",
                                    		xtype:'textfield',
                                    		value:record.data.leaderman,
                                    		anchor:'98%'
                                		}]
                                	},{
		                          		columnWidth:1,
		                          		layout:'form',
		                          		labelWidth:80,
		                          		items:[{
		                          		   id:'txtUpdateUserid',
			                           	   fieldLabel:"管理人员",
			                           	   xtype:'combo',
			                           	   displayField : 'realname',
								           valueField : 'id',
								           typeAhead : true,
								           mode : 'remote',
								           editable : false,
								           selectOnFoucs : true,
								           triggerAction : 'all',
								           store:comboStore,
								           emptyText:"请选择管理员",
		                          		   value:record.data.userid,
								           anchor:'98%'
		                          		}]
		                          	}]
		                          }],
		                          buttons:[{
		                          	id:'SaveBtn',
		                          	text:"保存",
		                          	handler:function(){
		                          	     if(Ext.getCmp("combRegion").getValue()==""){Ext.ux.Toast.msg("提示","请选择行政区划.");return;}
		                                 if(Ext.getCmp("txtRegionid").getValue()==""){Ext.ux.Toast.msg("提示","请选择行政区划.");return;}
		                                 if(Ext.getCmp("txtUpdateUseunit").getValue()==""){Ext.ux.Toast.msg("提示","请填写使用单位.");return;}
		                                 if(Ext.getCmp("txtUpdateResponsiblemen").getValue()==""){Ext.ux.Toast.msg("提示","请填写负责人.");return;}
		                                 if(Ext.getCmp("txtUpdateLinktel").getValue()==""){Ext.ux.Toast.msg("提示","请填写联系电话.");return;}
		                                 if(Ext.getCmp("txtUpdateAddress").getValue()==""){Ext.ux.Toast.msg("提示","请填写单位地址.");return;}
		                                 if(Ext.getCmp("txtUpdateZipcode").getValue()==""){Ext.ux.Toast.msg("提示","请填写邮政编码.");return;}
		                                 if(Ext.getCmp("txtUpdateChaptercode").getValue()==""){Ext.ux.Toast.msg("提示","请填写条章编号.");return;}
		                                 if(Ext.getCmp("txtUpdatePlatecode").getValue()==""){Ext.ux.Toast.msg("提示","请填写号牌代码.");return;}
		                                 if(Ext.getCmp("txtUpdateRegistman").getValue()==""){Ext.ux.Toast.msg("提示","请填写登记审核人.");return;}
                                         if(Ext.getCmp("txtUpdatePaiZhengMan").getValue()==""){Ext.ux.Toast.msg("提示","请填写牌证管理员.");return;}
                                         if(Ext.getCmp("txtUpdateLeaderMan").getValue()==""){Ext.ux.Toast.msg("提示","请填写业务领导.");return;}
		                                 if(Ext.getCmp("txtUpdateUserid").getValue()==""){Ext.ux.Toast.msg("提示","请选择管理人员.");return;}
		                                 Ext.Ajax.request({
		                                  url:"main/unitManage.html?action=updateUnitManage",
		                                  method:"post",
		                                  success:function(){Ext.ux.Toast.msg("提示","修改信息成功.");Ext.getCmp("typeUpdatewin").close(); ds.reload();},
		                                  failure:function(){ Ext.Msg.alert("警告","<font color=red>与服务器通信失败!</font>");},
		                                  params:{
		                                        id:record.data.id,
		                                        region:Ext.getCmp("combRegion").getValue(),
		                                        regionid:Ext.getCmp("txtRegionid").getValue(),
		                                        useunit:Ext.getCmp("txtUpdateUseunit").getValue(),
		                                        responsiblemen:Ext.getCmp("txtUpdateResponsiblemen").getValue(),
		                                        linktel:Ext.getCmp("txtUpdateLinktel").getValue(),
		                                        address:Ext.getCmp("txtUpdateAddress").getValue(),
		                                        zipcode:Ext.getCmp("txtUpdateZipcode").getValue(),
		                                        chaptercode:Ext.getCmp("txtUpdateChaptercode").getValue(),
		                                        platecode:Ext.getCmp("txtUpdatePlatecode").getValue(),
		                                        registMan:Ext.getCmp("txtUpdateRegistman").getValue(),
                                                paizhengman:Ext.getCmp("txtUpdatePaiZhengMan").getValue(),
                                                leaderman:Ext.getCmp("txtUpdateLeaderMan").getValue(),
		                                        userid:Ext.getCmp("txtUpdateUserid").getValue()}
		                                 });
		                          	}
		                          },{
		                          	id:'CancelBtn',
		                          	text:"取消",
		                          	handler:function(){
		                          		Ext.getCmp("typeUpdatewin").close();
		                          	}
		                          }]
		                      }).show(this);
                    });
                }
});
Ext.reg('unitmanagegrid',Ynzc.manage.UnitManageGrid);